{% comment %} {% load i18n %} {% endcomment %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        {% load static %}
        <link rel="apple-touch-icon" sizes="180x180" href="/static/icons/apple-touch-icon.png">
        <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
        {% load static %}
        <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
        <link rel="stylesheet" href="{% static 'css/styles.css' %}?v=1.4">
        <link rel="stylesheet" href="{% static 'bootstrap-icons/bootstrap-icons.css' %}" >
        <link rel="stylesheet" href="{% static 'bootstrap-icons/bootstrap-icons.css' %}" >
        <link rel="stylesheet" href="{% static "css/fontfaces.css" %}">
        <script src="{% static 'js/bootstrap.bundle.min.js' %}"></script>
        {% block styles %}{% endblock %}
    <title>{% block title %}Title Default{% endblock %}</title>
</head>
<body class="d-flex flex-column min-vh-100">
    {% include '_include/_header.html' %}
    <main class="container flex-grow-1">
        
        <div id="top-bar" class="container mt-3 mb-3">
            <div class="row align-items-center">
                <!-- Título -->
                <div class="col-12 col-md-6 text-center text-md-start mb-2 mb-md-0">
                <h1 class="title">{% block title_h1 %}Title default{% endblock %}</h1>
                </div>

                <!-- Barra de búsqueda -->
                <div class="col-12 col-md-6">
                {% block search_bar %}
                <form class="d-flex justify-content-center justify-content-md-end" method="get" action="{% url 'profiles:search' %}">
                    <input class="form-control me-2" type="search" name="query" placeholder="Buscar usuarios" id="user-search" value="{{ request.GET.query }}">
                    <button class="btn btn-outline-primary" type="submit" id="search-btn">
                    <i class="bi bi-search"></i>
                    </button>
                </form>
                {% endblock %}
                </div>
            </div>
        </div>
        
        {% comment %} {% block search_form %}
            {% if search_form %}
            <form method="GET" action="{% url 'search' %}">
                {{search_form.as_p}}
                <button type='submit'>Enviar</button>
            </form>
            {% else%}
            {% endif %}
        {% endblock %} {% endcomment %}
    
        {% block messages %}
            {% if messages %} 
                {% for message in messages %} 
                    <div{% if message.tags %} class="alert alert-{{ message.tags }}"{% endif %}><span>{{ message }}</span></div> 
                {% endfor %} 
            {% endif %}
        {% endblock %}
        
        {% block form %}
        {% endblock %}
        
        {% block content %}
        {% endblock %}
        
        
    </main>
    {% block script %}
        <script>
            document.addEventListener('DOMContentLoaded', function() {
                const likeButtons = document.querySelectorAll('.like-button');
                
                likeButtons.forEach(button => {
                    button.addEventListener('click', function(event) {
                        event.preventDefault();
            
                        const postId = button.dataset.postId;
                        const nLikesSpan = document.querySelector(`.n-likes[data-post-id="${postId}"]`);

                        fetch(button.href, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'X-CSRFToken': getCSRFToken() // Asegúrate de incluir el token CSRF
                            }
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.liked) {
                                button.innerHTML = `<i class="bi bi-heart-fill text-danger"></i>
                                                    <span class="sr-only">Unlike this post</span>
                                                    <span data-post-id="{{ post.pk }}" class="n-likes">${data.nLikes}</span>`;
                            } else {
                                button.innerHTML = `<i class="bi bi-heart text-danger"></i>
                                                    <span class="sr-only">Like this post</span>
                                                    <span data-post-id="{{ post.pk }}" class="n-likes">${data.nLikes}</span>`;
                            }
                        })
                        .catch(error => console.error('Error:', error));
                    });
                });
            });
            
            function getCSRFToken() {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // ¿Esta cookie comienza con el prefijo CSRF?
                        if (cookie.substring(0, 10) === 'csrftoken=') {
                            cookieValue = decodeURIComponent(cookie.substring(10));
                            break;
                        }
                    }
                }
                return cookieValue;
            }    

            function toggleNavbar() {
                const toggleIcon = document.querySelector('.toggle-navbar-icon');
                const navbar = document.getElementById('navbar');

                navbar.toggleAttribute('hidden');
                if (toggleIcon.classList.contains('opened')) {
                    toggleIcon.classList.remove('opened');
                } else {
                    toggleIcon.classList.add('opened')
                }
            }

            const toggleBtn = document.getElementById('menuToggleBtn');
            const sidebar = document.getElementById('sidebarMenu');

            sidebar.addEventListener('show.bs.collapse', () => {
                toggleBtn.classList.remove('btn-outline-primary');
                toggleBtn.classList.add('btn-primary');
            });

            sidebar.addEventListener('hide.bs.collapse', () => {
                toggleBtn.classList.remove('btn-primary');
                toggleBtn.classList.add('btn-outline-primary');
            });

            const navbarIcon = document.getElementById("navbar-icon");
            let lastScrollY = window.scrollY;
            let hideTimeout;
            let inactivityTimeout;

            function showIcon() {
                navbarIcon.classList.remove("hidden", "none");
                clearTimeout(hideTimeout);
                clearTimeout(inactivityTimeout);
                startInactivityTimer();
            }

            function hideIconWithDelay() {
                navbarIcon.classList.add("hidden");
                hideTimeout = setTimeout(() => {
                navbarIcon.classList.add("none");
                }, 2000);
            }

            function startInactivityTimer() {
                inactivityTimeout = setTimeout(() => {
                hideIconWithDelay();
                }, 2000);
            }

            // Reiniciar temporizador si hay interacción con el icono
            function resetInactivityTimer() {
                clearTimeout(inactivityTimeout);
                showIcon();
            }

            // Eventos que cuentan como interacción
            navbarIcon.addEventListener("mouseenter", resetInactivityTimer);
            navbarIcon.addEventListener("mouseleave", resetInactivityTimer);
            navbarIcon.addEventListener("click", resetInactivityTimer);
            navbarIcon.addEventListener("touchstart", resetInactivityTimer);

            window.addEventListener("scroll", () => {
                const currentScroll = window.scrollY;

                if (window.innerWidth < 768) {
                if (currentScroll === 0) {
                    showIcon();
                } else if (currentScroll > lastScrollY) {
                    hideIconWithDelay();
                }
                }

                lastScrollY = currentScroll;
            });

            // Inicializamos timer al cargar página
            startInactivityTimer()
        </script>
    {% endblock %}
    {% block session %}
            {% if request.user.is_authenticated %}
            <div class="container mt-4">
                <div class="session-bar d-flex flex-column flex-sm-row justify-content-between align-items-center p-3 rounded shadow-sm bg-light">
                    
                    <div class="text-muted mb-2 mb-sm-0 small">
                    Sesión iniciada como <span class="text-primary fw-semibold">{{ request.user.username }}</span>
                    </div>

                    <form action="{% url 'logout' %}" method="POST" class="m-0">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-outline-danger btn-sm">Cerrar sesión</button>
                    </form>
                </div>
                </div>
            {% endif %}
        {% endblock %}
    {% include "_include/_footer.html" %}
</body>
</html>