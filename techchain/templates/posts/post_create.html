{% extends 'layout/layout_basic.html' %}
{% load crispy_forms_tags %}
{% block styles %}
{% load static%}
<link rel="stylesheet" href="{% static 'css/post_create.css' %}?v=1.1">
{% endblock %}
{% block title %}Publicaciones{% endblock %}
{% block title_h1 %}
    {% if form.instance.pk %}
        Edita tu publicaci贸n
    {% else %}
        Crea tu publicaci贸n
    {% endif %}
{% endblock %}
{% block form %}
<form method="POST" enctype="multipart/form-data" class="p-4 border rounded shadow-sm" id="postForm">
    {% csrf_token %}
    {{ form.media }}
    {% if form.instance.image %}
    <div class="text-center mb-3">
    <p class="mb-2">Imagen actual:</p>
    <img src="{{ form.instance.image.url }}" 
        alt="Imagen actual" 
        class="img-fluid rounded shadow-sm" 
        style="max-width: 300px; height: auto;">
    </div>
    {% endif %}

    {% for field in form %}
    <div class="mb-3">
        <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
        {{ field }}
        {% if field.help_text %}
        <small class="form-text text-muted">{{ field.help_text }}</small>
        {% endif %}
        {% for error in field.errors %}
        <div class="text-danger">{{ error }}</div>
        {% endfor %}
    </div>
    {% endfor %}

    <!-- Previsualizaci贸n -->
    <div class="text-center mb-3">
    <button type="button" id="toggleAspect" class="btn btn-sm btn-outline-primary" style="display: none;">
        Cambiar proporci贸n
    </button>
    </div>

    <div id="previewContainer" class="d-flex justify-content-center align-items-center mb-3" 
        style="max-width: 100%; max-height: 400px; overflow: hidden; display: none;">
    <img id="imagePreview" 
        src="{% if form.instance.image %}{{ form.instance.image.url }}{% endif %}"
        class="img-fluid img-thumbnail shadow-sm"
        alt="Vista previa"
        style="max-width: 100%; height: auto; object-fit: cover; display: none;">
    </div>

    <div class="d-flex gap-2 mb-3">
        <button type="submit" class="btn btn-primary">Guardar</button>
        <button type="reset" class="btn btn-secondary">Limpiar</button>
        <a href="{% url 'posts:list' user_uuid %}" class="btn btn-outline-secondary">Salir</a>
    </div>
</form>

<!-- Cropper.js -->
<link href="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/cropperjs@1.6.2/dist/cropper.min.js"></script>

{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fileInput = document.getElementById('imageInput');
        const imagePreview = document.getElementById('imagePreview');

        fileInput.addEventListener('change', function (event) {
            const file = event.target.files[0]; // Obtiene el archivo seleccionado
            if (file) {
                const reader = new FileReader(); // Crea un FileReader para leer el archivo
                reader.onload = function (e) {
                    imagePreview.src = e.target.result; // Establece la imagen en el atributo src
                    imagePreview.style.display = 'block'; // Muestra la imagen
                };
                reader.readAsDataURL(file); // Lee el archivo como una URL de datos
            } else {
                imagePreview.src = '';
                imagePreview.style.display = 'none'; // Oculta la imagen si no hay archivo
            }
        });
    });
</script>
<script>
    let cropper;
    const input = document.getElementById('imageInput');
    const img = document.getElementById('imagePreview');
    const form = document.getElementById('postForm');
    const toggleBtn = document.getElementById('toggleAspect');
    const prevContainer = document.getElementById('previewContainer');


    input.addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;

        const url = URL.createObjectURL(file);
        img.src = url;
        img.style.display = 'block';
        toggleBtn.style.display = 'inline-block';

        if (cropper) cropper.destroy();

        cropper = new Cropper(img, {
            aspectRatio: NaN,    
            viewMode: 1,
            autoCropArea: 1,
            background: false
        });
    });

    form.addEventListener('submit', e => {
        if (cropper) {
            e.preventDefault();
            cropper.getCroppedCanvas().toBlob(blob => {
                const file = new File([blob], 'cropped.png', { type: 'image/png' });
                const formData = new FormData(form);
                formData.set('image', file);
                fetch(form.action, {
                    method: 'POST',
                    body: formData
                }).then(resp => {
                    if (resp.ok) location.reload();
                });
            });
        }
    });

    let aspect = 1;

    toggleBtn.addEventListener('click', () => {
        if (!cropper) return;
        aspect = aspect === 1 ? NaN : 1;
        cropper.setAspectRatio(aspect);
        toggleBtn.textContent = aspect === 1 ? 'Cambiar a libre' : 'Cambiar a cuadrado';
    });

</script>
{% endblock %}